(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.bus=f()}})(function(){var define,module,exports;return function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r}()({1:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var Adapter=function(){function Adapter(){}return Adapter}();exports.Adapter=Adapter},{}],2:[function(require,module,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:true});var counter=0;function uniqueId(prefix){return""+(prefix||"web-bus-id")+counter++}var Bus=function(){function Bus(adapter,defaultTimeout){var _this=this;this.id=uniqueId("bus");this._timeout=defaultTimeout||5e3;this._adapter=adapter;this._adapter.addListener(function(data){return _this._onMessage(data)});this._eventHandlers=Object.create(null);this._activeRequestHash=Object.create(null);this._requestHandlers=Object.create(null)}Bus.prototype.dispatchEvent=function(name){this._adapter.send(Bus._createEvent(name));return this};Bus.prototype.request=function(name,data,timeout){var _this=this;return new Promise(function(resolve,reject){var id=uniqueId(_this.id+"-action");_this._activeRequestHash[id]={reject:reject,resolve:resolve};setTimeout(function(){delete _this._activeRequestHash[id];reject(new Error("Timeout error!"))},timeout||_this._timeout);_this._adapter.send({id:id,type:1,name:name,data:data})})};Bus.prototype.on=function(name,handler,context){return this._addEventHandler(name,handler,context,false)};Bus.prototype.once=function(name,handler,context){return this._addEventHandler(name,handler,context,true)};Bus.prototype.off=function(name,handler){var _this=this;if(!name){Object.keys(this._eventHandlers).forEach(function(name){return _this.off(name,handler)});return this}if(!this._eventHandlers[name]){return this}if(!handler){this._eventHandlers[name].slice().forEach(function(info){_this.off(name,info.handler)});return this}this._eventHandlers[name]=this._eventHandlers[name].filter(function(info){return info.handler!==handler});if(!this._eventHandlers[name].length){delete this._eventHandlers[name]}return this};Bus.prototype.registerRequestHandler=function(name,handler){if(this._requestHandlers[name]){throw new Error("Duplicate request handler!")}this._requestHandlers[name]=handler;return this};Bus.prototype.changeAdapter=function(adapter){var _this=this;var bus=new Bus(adapter,this._timeout);Object.keys(this._eventHandlers).forEach(function(name){_this._eventHandlers[name].forEach(function(info){if(info.once){bus.once(name,info.handler,info.context)}else{bus.on(name,info.handler,info.context)}})});Object.keys(this._requestHandlers).forEach(function(name){bus.registerRequestHandler(name,_this._requestHandlers[name])});return bus};Bus.prototype._addEventHandler=function(name,handler,context,once){if(!this._eventHandlers[name]){this._eventHandlers[name]=[]}this._eventHandlers[name].push({handler:handler,once:once,context:context});return this};Bus.prototype._onMessage=function(message){switch(message.type){case 0:this._fireEvent(message.name,message.data);break;case 1:this._createResponse(message);break;case 2:this._fireEndAction(message);break}};Bus.prototype._createResponse=function(message){var _this=this;var sendError=function(error){_this._adapter.send({id:message.id,type:2,status:1,content:error})};if(!this._requestHandlers[message.name]){sendError(new Error("Has no handler for this action!"));return null}try{var result=this._requestHandlers[message.name](message.data);if(Bus._isPromise(result)){result.then(function(data){_this._adapter.send({id:message.id,type:2,status:0,content:data})},sendError)}else{this._adapter.send({id:message.id,type:2,status:0,content:result})}}catch(e){sendError(e)}};Bus.prototype._fireEndAction=function(message){if(this._activeRequestHash[message.id]){switch(message.status){case 1:this._activeRequestHash[message.id].reject(message.content);break;case 0:this._activeRequestHash[message.id].resolve(message.content);break}delete this._activeRequestHash[message.id]}};Bus.prototype._fireEvent=function(name,value){if(!this._eventHandlers[name]){return null}this._eventHandlers[name]=this._eventHandlers[name].slice().filter(function(handlerInfo){try{handlerInfo.handler.call(handlerInfo.context,value)}catch(e){console.warn(e)}return!handlerInfo.once});if(!this._eventHandlers[name].length){delete this._eventHandlers[name]}};Bus._createEvent=function(eventName){return{type:0,name:eventName}};Bus._isPromise=function(some){return some&&some.then&&typeof some.then==="function"};return Bus}();exports.Bus=Bus},{}],3:[function(require,module,exports){"use strict";var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:true});var Adapter_1=require("./Adapter");var WindowAdapter=function(_super){__extends(WindowAdapter,_super);function WindowAdapter(listen,dispatch,availableDomains){var _this=_super.call(this)||this;_this._availableDomains=[listen.origin,dispatch.origin].concat(availableDomains||[]);_this._dispatch=dispatch;_this._listen=listen;_this._listeners=[];_this._mainListener=function(event){return _this._onEvent(event)};_this._listen.win.addEventListener("message",_this._mainListener,false);return _this}WindowAdapter.prototype.send=function(data){this._dispatch.win.postMessage(data,this._dispatch.origin);return this};WindowAdapter.prototype.addListener=function(cb){this._listeners.push(cb);return this};WindowAdapter.prototype.destroy=function(){this._listen.win.removeEventListener("message",this._mainListener,false);this._listeners=[];this._listen=null;this._dispatch=null};WindowAdapter.prototype._onEvent=function(event){if(this._availableDomains.indexOf(event.origin)!==-1){this._listeners.forEach(function(handler){handler(event.data)})}};return WindowAdapter}(Adapter_1.Adapter);exports.WindowAdapter=WindowAdapter},{"./Adapter":1}],4:[function(require,module,exports){"use strict";function __export(m){for(var p in m)if(!exports.hasOwnProperty(p))exports[p]=m[p]}Object.defineProperty(exports,"__esModule",{value:true});__export(require("./Bus"));__export(require("./Adapter"));__export(require("./WindowAdapter"))},{"./Adapter":1,"./Bus":2,"./WindowAdapter":3}]},{},[4])(4)});